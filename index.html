<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>FC26 Manager - Ultimate Data Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
--bg: #05070a; --card: #111418; --border: #30363d;
--accent: #238636; --blue: #58a6ff; --gold: #d4af37;
--silver: #bec2cb; --bronze: #cd7f32;
--text: #f8fafc; --muted: #8b949e; --danger: #da3633;
--purple: #8957e5;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 90px; }

/* --- STYLES EXPORT PDF --- */
.pdf-export-content { background: white; color: black; padding: 40px; font-family: Arial, sans-serif; }
.pdf-header { text-align: center; border-bottom: 2px solid #1e1b4b; margin-bottom: 20px; padding-bottom: 10px; }
.pdf-season-block { margin-bottom: 30px; page-break-inside: avoid; }
.pdf-season-title { color: #1e1b4b; background: #f0f0f0; padding: 8px 15px; border-left: 5px solid #238636; margin-bottom: 10px; }
.pdf-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
.pdf-table th, .pdf-table td { border: 1px solid #ccc; padding: 8px; text-align: center; font-size: 9pt; }
.pdf-table th { background: #e9ecef; font-weight: bold; }

#syncNotify { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: var(--purple); color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; z-index: 2000; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); transition: 0.3s; }

#loginOverlay, #pinOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
#pinOverlay { display: none; background: rgba(5, 7, 10, 0.98); }
.login-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; margin-top: 30px; }
.user-btn { background: var(--card); border: 1px solid var(--border); color: white; padding: 20px; border-radius: 15px; cursor: pointer; text-align: center; transition: 0.3s; }
.user-btn:hover { border-color: var(--purple); transform: translateY(-5px); }
.admin-lock { border-color: var(--gold); }
.pin-input { background: #000; border: 2px solid var(--border); color: var(--gold); font-size: 2rem; width: 150px; text-align: center; border-radius: 12px; margin: 20px 0; letter-spacing: 10px; padding: 10px; }

header { background: #010409; padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; z-index:100; }
.season-badge { background: var(--gold); color: #000; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
.sync-status { font-size: 0.6rem; color: var(--accent); display: flex; align-items: center; gap: 5px; }

.ticker-wrap { background: #010409; border-bottom: 1px solid var(--border); overflow: hidden; white-space: nowrap; padding: 5px 0; }
.ticker { display: inline-block; animation: ticker 40s linear infinite; }
.ticker-item { display: inline-block; padding: 0 20px; font-size: 0.65rem; color: var(--muted); border-right: 1px solid var(--border); }
.ticker-item b { color: var(--blue); margin: 0 5px; }
@keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

nav { position: fixed; bottom: 0; left: 0; right: 0; background: #111418; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid var(--border); z-index: 1000; }
nav button { background: none; border: none; color: var(--muted); display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; gap: 5px; cursor: pointer; }
nav button.active { color: var(--accent); }

main { padding: 15px; max-width: 600px; margin: auto; }
.card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 16px; position: relative; }

.sparkline-box { display: flex; align-items: flex-end; gap: 3px; height: 24px; justify-content: center; overflow: hidden; }
.spark-bar { width: 5px; background: var(--border); border-radius: 1px; transition: height 0.3s; min-height: 2px; }
.spark-up { background: var(--accent) !important; }
.spark-down { background: var(--danger) !important; }

.badge-container { display: flex; gap: 5px; margin-top: 4px; flex-wrap: wrap; }
.prestige-badge { font-size: 0.55rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; display: flex; align-items: center; gap: 3px; }
.badge-sniper { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
.badge-mur { background: #dcfce7; color: #166534; border: 1px solid #22c55e; }
.badge-clutch { background: #ede9fe; color: #5b21b6; border: 1px solid #8b5cf6; }
.badge-clean { background: #e0f2fe; color: #0369a1; border: 1px solid #0ea5e9; }

.medal-card { display: flex; align-items: center; gap: 15px; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid transparent; }
.medal-gold { background: linear-gradient(90deg, #d4af3722, transparent); border-left-color: var(--gold); }
.medal-silver { background: linear-gradient(90deg, #bec2cb22, transparent); border-left-color: var(--silver); }
.medal-bronze { background: linear-gradient(90deg, #cd7f3222, transparent); border-left-color: var(--bronze); }
.hof-stat { font-size: 1.2rem; font-weight: bold; }
.hof-label { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; }

table { width: 100%; border-collapse: collapse; }
th { color: var(--muted); font-size: 0.6rem; text-transform: uppercase; padding-bottom: 10px; }
td { padding: 12px 2px; border-bottom: 1px solid #30363d55; font-size: 0.85rem; vertical-align: middle; }
.col-player { text-align: left; padding-left: 5px; width: 35%; }
.col-center { text-align: center; }

.val-badge { background: #1e1b4b; color: var(--blue); padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.7rem; }

.stat-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #ffffff05; }
.stat-label { font-size: 0.75rem; color: var(--muted); }
.stat-value { font-size: 0.85rem; font-weight: 600; }

.tactic-badge { background: #1e1b4b; color: var(--blue); padding: 4px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: bold; display: inline-block; margin-bottom: 10px; }
.tactic-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.7rem; }
.tactic-item { background: #0a0c10; padding: 8px; border-radius: 8px; border-left: 3px solid var(--purple); }

.predict-card { background: linear-gradient(135deg, #1e1b4b 0%, #111418 100%); border: 1px solid var(--purple); padding: 20px; margin-bottom:15px; }
.live-predict-card { background: linear-gradient(135deg, #0f172a 0%, #020617 100%); border: 1px solid var(--accent); padding: 15px; }

.brief-title { color: var(--gold); font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; font-size: 0.7rem; }
.brief-advice { color: var(--muted); font-style: italic; display: block; margin-top: 5px; border-top: 1px solid #333; padding-top: 5px; }

.team-row { display: flex; align-items: center; justify-content: space-between; margin: 8px 0; }
.team-select { background: #000; color: white; border: 1px solid var(--border); border-radius: 8px; padding: 6px; font-size: 0.7rem; width: 110px; }
.score-input { width: 45px; height: 40px; background: #000; border: 1px solid var(--border); color: white; text-align: center; border-radius: 8px; font-weight: bold; font-size: 1.1rem; }

.btn-primary { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; }
.btn-edit { background: none; border: 1px solid var(--blue); color: var(--blue); padding: 4px 8px; border-radius: 6px; font-size: 0.6rem; cursor: pointer; }
.edit-box { background: #000; padding: 15px; border-radius: 10px; margin-top: 10px; border: 1px dashed var(--blue); text-align: center; }

#winnerModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:2000; justify-content:center; align-items:center; text-align:center; padding: 20px; }

.match-commentary { 
    background: rgba(88, 166, 255, 0.05); border: 1px solid #30363d; padding: 8px 12px; border-radius: 8px; margin-top: 10px; font-size: 0.7rem; color: var(--muted); font-style: italic; line-height: 1.3;
}
.match-commentary b { color: var(--blue); }
</style>
</head>
<body>

<div id="syncNotify"><i class="fas fa-sync-alt fa-spin"></i> Mise √† jour Live...</div>

<div id="loginOverlay">
<i class="fas fa-shield-halved" style="font-size: 3rem; color: var(--purple); margin-bottom: 10px;"></i>
<h2 style="margin:0">FC26 ELITE</h2>
<div class="login-grid">
<div class="user-btn admin-lock" onclick="checkPin()"><i class="fas fa-user-crown" style="color:var(--gold)"></i>ADMIN</div>
<div class="user-btn" onclick="login('BVI')"><i class="fas fa-user"></i>BVI</div>
<div class="user-btn" onclick="login('NAD')"><i class="fas fa-user"></i>NAD</div>
<div class="user-btn" onclick="login('WIL')"><i class="fas fa-user"></i>WIL</div>
<div class="user-btn" onclick="login('BROOK')"><i class="fas fa-user"></i>BROOK</div>
</div>
</div>

<div id="pinOverlay">
<input type="password" id="pinCode" class="pin-input" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
<button class="btn-primary" onclick="validatePin()">OK</button>
</div>

<div id="winnerModal">
<div style="background: var(--card); padding: 40px; border-radius: 30px; border: 2px solid var(--gold);">
<i class="fas fa-trophy" style="font-size: 4rem; color: var(--gold); margin-bottom: 20px;"></i>
<h1 id="winnerName">-</h1>
<button class="btn-primary" onclick="closeWinner()">NOUVELLE SAISON üî•</button>
</div>
</div>

<header>
<div onclick="logout()" style="cursor:pointer"><i class="fas fa-power-off"></i> <span id="userDisplay" style="font-size:0.7rem; color:var(--muted); margin-left:5px"></span></div>
<div style="display:flex; align-items:center; gap:10px">
<div class="sync-status" id="syncStatus"><i class="fas fa-circle" style="font-size:0.5rem"></i> LIVE</div>
<div id="seasonBadge" class="season-badge">Saison 1</div>
</div>
</header>

<div id="resultTicker" class="ticker-wrap"></div>

<main id="app"></main>

<nav>
<button class="active" data-tab="dashboard"><i class="fas fa-chart-line"></i><span>Stats</span></button>
<button data-tab="analysis"><i class="fas fa-brain"></i><span>IA</span></button>
<button data-tab="matches"><i class="fas fa-gamepad"></i><span>Jouer</span></button>
<button data-tab="players"><i class="fas fa-users"></i><span>Joueurs</span></button>
<button data-tab="hof"><i class="fas fa-crown"></i><span>H.O.F</span></button>
<button data-tab="archives"><i class="fas fa-history"></i><span>Palmar√®s</span></button>
</nav>

<script>
const FB_URL = "https://fc26-e596e-default-rtdb.europe-west1.firebasedatabase.app/data.json";
const ADMIN_PIN = "1234";
const TEAMS = ["Real Madrid", "Man City", "Barcelone", "Bayern Munich", "Liverpool", "PSG", "Arsenal", "Inter Milan", "Milan AC", "Atletico", "Leverkusen", "Dortmund", "Juventus", "Naples", "Chelsea", "Aston Villa"];

let currentUser = localStorage.getItem("fc26_user") || null;
let state = { season: 1, players: [], currentDay: [], archives: [], rotationQueue: [] };
let isInteracting = false;

const notifySound = new Audio("https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3");
const qs = (s) => document.querySelector(s);
const isAdmin = () => currentUser === 'ADMIN';

async function pushData() { if (isAdmin()) { try { await fetch(FB_URL, { method: 'PUT', body: JSON.stringify(state) }); } catch (e) {} } }
async function pullData() {
if (isInteracting) return;
try {
const res = await fetch(FB_URL);
const data = await res.json();
if (data && JSON.stringify(data) !== JSON.stringify(state)) {
state = data; render(); showNotify(); qs('#seasonBadge').innerText = `SAISON ${state.season}`;
}
} catch (e) {}
}

function showNotify() { const n = qs("#syncNotify"); n.style.display = "block"; notifySound.play().catch(e => {}); setTimeout(() => { n.style.display = "none"; }, 3000); }
setInterval(pullData, 5000);

function updateTicker() {
    const ticker = qs("#resultTicker");
    if (!state.archives || state.archives.length === 0) { ticker.style.display = "none"; return; }
    ticker.style.display = "block";
    const lastMatches = state.archives.flat().slice(-10).reverse();
    const content = lastMatches.map(m => `<div class="ticker-item">${m.p1} <b>${m.s1}-${m.s2}</b> ${m.p2}</div>`).join('');
    ticker.innerHTML = `<div class="ticker">${content}${content}</div>`;
}

function checkPin() { qs('#pinOverlay').style.display = 'flex'; qs('#pinCode').focus(); }
function validatePin() { if(qs('#pinCode').value === ADMIN_PIN) { qs('#pinOverlay').style.display = 'none'; login('ADMIN'); } else { alert("PIN Incorrect"); } }
function login(user) { currentUser = user; localStorage.setItem("fc26_user", user); qs('#loginOverlay').style.display = 'none'; qs('#userDisplay').innerText = user; pullData(); }
function logout() { localStorage.removeItem("fc26_user"); location.reload(); }
if(currentUser) login(currentUser);
function save() { if(isAdmin()) pushData(); render(); }

// --- LOGIQUE TIE-BREAKER (NOUVEAU) ---
function runTieBreaker(p1, p2) {
    const val1 = Math.floor(Math.random() * 100) + 1;
    const val2 = Math.floor(Math.random() * 100) + 1;
    if (val1 === val2) return runTieBreaker(p1, p2); 
    const winner = val1 > val2 ? p1 : p2;
    const container = qs("#tieBreakerResult");
    container.innerHTML = `
        <div class="edit-box" style="border-color: var(--purple); background: rgba(137, 87, 229, 0.1);">
            <div style="font-size: 0.6rem; color: var(--muted); margin-bottom: 10px;"><i class="fas fa-dice"></i> TIRAGE AU SORT (MATCH NUL)</div>
            <div style="display: flex; justify-content: space-around; align-items: center;">
                <div><div style="font-size: 0.6rem;">${p1}</div><div style="font-size: 1.2rem; font-weight: bold; color: ${val1 > val2 ? 'var(--accent)' : 'var(--muted)'}">${val1}</div></div>
                <div style="font-size: 0.8rem; color: var(--muted)">VS</div>
                <div><div style="font-size: 0.6rem;">${p2}</div><div style="font-size: 1.2rem; font-weight: bold; color: ${val2 > val1 ? 'var(--accent)' : 'var(--muted)'}">${val2}</div></div>
            </div>
            <div style="margin-top: 10px; font-weight: bold; color: var(--gold); font-size: 0.8rem;">üèÜ ${winner} RESTE EN JEU</div>
        </div>
    `;
}

// --- CALCULS & STATS ---
function calculateValue(p) { 
    let base = 10;
    let ptsValue = (p.points || 0) * 1.5;
    let gdValue = ((p.gf || 0) - (p.ga || 0)) * 0.5;
    let csValue = (p.cs || 0) * 1.0;
    return (base + ptsValue + gdValue + csValue).toFixed(1); 
}

function getForm(name) {
    const history = []; const allMatches = state.archives ? state.archives.flat() : [];
    [...allMatches].reverse().forEach(m => {
        if((m.p1 === name || m.p2 === name) && history.length < 5) {
            const win = (m.p1 === name) ? m.s1 > m.s2 : m.s2 > m.s1;
            const draw = m.s1 === m.s2;
            history.push(win ? 'win' : (draw ? 'draw' : 'loss'));
        }
    });
    return history;
}

function getAllTimeStats() {
    let stats = {}; if(!state.archives) return stats;
    state.archives.flat().forEach(m => {
        if(!stats[m.p1]) stats[m.p1] = { gf:0, ga:0, pts:0, cs:0, games:0 };
        if(!stats[m.p2]) stats[m.p2] = { gf:0, ga:0, pts:0, cs:0, games:0 };
        stats[m.p1].gf += m.s1; stats[m.p1].ga += m.s2; stats[m.p1].games++;
        stats[m.p2].gf += m.s2; stats[m.p2].ga += m.s1; stats[m.p2].games++;
        if(m.s2 === 0) stats[m.p1].cs++;
        if(m.s1 === 0) stats[m.p2].cs++;
        if(m.s1 > m.s2) stats[m.p1].pts += 3; else if(m.s2 > m.s1) stats[m.p2].pts += 3; else { stats[m.p1].pts++; stats[m.p2].pts++; }
    });
    return stats;
}

function getMatchBriefing(p1Name, p2Name) {
    const allMatches = state.archives ? state.archives.flat() : [];
    const stats = getAllTimeStats();
    let headToHead = { p1Wins: 0, p2Wins: 0, draws: 0, p1Goals: 0, p2Goals: 0 };
    allMatches.forEach(m => {
        if((m.p1 === p1Name && m.p2 === p2Name) || (m.p1 === p2Name && m.p2 === p1Name)) {
            const p1IsM1 = m.p1 === p1Name;
            if(m.s1 === m.s2) headToHead.draws++;
            else if((p1IsM1 && m.s1 > m.s2) || (!p1IsM1 && m.s2 > m.s1)) headToHead.p1Wins++;
            else headToHead.p2Wins++;
        }
    });
    return { analysis: "Analyse des duels termin√©e.", advice: "IA: Restez concentr√© sur la d√©fense." };
}

function generateMatchCommentary(m) {
    const winner = m.s1 > m.s2 ? m.p1 : (m.s2 > m.s1 ? m.p2 : null);
    if (winner) return `Victoire de <b>${winner}</b>.`;
    return "Match nul √©quilibr√©.";
}

function validateMatch() {
    if(!isAdmin()) return;
    const s1 = parseInt(qs('#s1').value) || 0;
    const s2 = parseInt(qs('#s2').value) || 0;
    const t1 = qs('#t1').value;
    const t2 = qs('#t2').value;
    const m = state.currentDay[0];
    m.s1 = s1; m.s2 = s2; m.team1 = t1; m.team2 = t2; m.done = true; m.date = new Date().toLocaleString();
    m.seasonRef = state.season;
    m.commentary = generateMatchCommentary(m);
    let p1 = state.players.find(p => p.name === m.p1);
    let p2 = state.players.find(p => p.name === m.p2);
    p1.gf += s1; p1.ga += s2; p2.gf += s2; p2.ga += s1;
    if(s1 > s2) p1.points += 3; else if(s2 > s1) p2.points += 3; else { p1.points++; p2.points++; }
    if(s2 === 0) p1.cs++; if(s1 === 0) p2.cs++;
    if(!state.archives) state.archives = [];
    state.archives.push([m]);
    state.currentDay = [];
    save();
}

function startNextMatch(p1, p2) {
    if(!p1 || !p2) return;
    state.currentDay = [{ p1, p2, s1:0, s2:0, team1: TEAMS[0], team2: TEAMS[0], done: false }];
    save();
}

function exportFullHistoryPDF() {
    const container = document.createElement('div');
    container.className = 'pdf-export-content';
    container.innerHTML = `<h1>Historique FC26</h1>`;
    const opt = { margin: 10, filename: `FC26_History.pdf`, jsPDF: { unit: 'mm', format: 'a4' } };
    html2pdf().from(container).set(opt).save();
}

function render() {
    updateTicker();
    const tab = qs("nav button.active").dataset.tab;
    const app = qs("#app"); app.innerHTML = "";

    if (tab === "dashboard") {
        const sorted = [...state.players].sort((a,b) => b.points - a.points);
        app.innerHTML = `
            <div class="card">
                <table>
                    <thead><tr><th class="col-player">Joueur</th><th class="col-center">PTS</th><th class="col-center">VAL</th></tr></thead>
                    <tbody>
                        ${sorted.map(p => `<tr><td class="col-player"><b>${p.name}</b></td><td class="col-center">${p.points}</td><td class="col-center"><span class="val-badge">${calculateValue(p)}</span></td></tr>`).join('')}
                    </tbody>
                </table>
            </div>`;
    }

    if (tab === "matches") {
        if(state.currentDay.length === 0) {
            app.innerHTML = `<div class="card"><p>Nouveau Match :</p>
                <div class="login-grid">${state.players.map(p => `<button class="user-btn" onclick="startNextMatch('${p.name}', prompt('Contre qui?'))">${p.name}</button>`).join('')}</div>
            </div>`;
        } else {
            const m = state.currentDay[0];
            app.innerHTML = `
                <div class="card">
                    <div class="team-row"><span>${m.p1}</span><select id="t1" class="team-select">${TEAMS.map(t => `<option>${t}</option>`).join('')}</select><input type="number" id="s1" class="score-input" value="0"></div>
                    <div class="team-row"><span>${m.p2}</span><select id="t2" class="team-select">${TEAMS.map(t => `<option>${t}</option>`).join('')}</select><input type="number" id="s2" class="score-input" value="0"></div>
                    <div id="tieBreakerResult"></div>
                    <div style="display:flex; gap:10px; margin-top:20px">
                        <button class="btn-primary" onclick="validateMatch()">VALIDER</button>
                        <button class="btn-edit" style="border-color:var(--purple); color:var(--purple)" onclick="runTieBreaker('${m.p1}', '${m.p2}')"><i class="fas fa-dice"></i> TIE-BREAK</button>
                    </div>
                </div>`;
        }
    }

    if (tab === "analysis") {
        app.innerHTML = `<div class="card live-predict-card"><div class="brief-title">ANALYSE IA</div><p>Pr√™t pour le prochain duel.</p></div>`;
    }

    if (tab === "players") {
        app.innerHTML = state.players.map(p => `<div class="card"><b>${p.name}</b><div class="stat-row"><span>Buts</span><span>${p.gf}</span></div></div>`).join('');
    }

    if (tab === "hof") {
        app.innerHTML = `<div class="card" style="text-align:center"><h3>HALL OF FAME</h3><i class="fas fa-crown" style="color:var(--gold); font-size:3rem"></i></div>`;
    }

    if (tab === "archives") {
        app.innerHTML = `<button class="btn-primary" onclick="exportFullHistoryPDF()">PDF HISTORY</button>
            ${state.archives ? state.archives.flat().reverse().map(m => `<div class="card"><div style="display:flex; justify-content:space-around"><span>${m.p1}</span><b>${m.s1}-${m.s2}</b><span>${m.p2}</span></div></div>`).join('') : ''}`;
    }

    qs("nav").querySelectorAll("button").forEach(btn => btn.classList.toggle("active", btn.dataset.tab === tab));
}

document.querySelectorAll("nav button").forEach(btn => {
    btn.onclick = () => { qs("nav button.active").classList.remove("active"); btn.classList.add("active"); render(); };
});

pullData();
</script>
</body>
</html>
