<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>FC26 Manager - Ultimate Data Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
:root {
--bg: #05070a; --card: #111418; --border: #30363d;
--accent: #238636; --blue: #58a6ff; --gold: #d4af37;
--text: #f8fafc; --muted: #8b949e; --danger: #da3633;
--purple: #8957e5;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 90px; }

#syncNotify { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: var(--purple); color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; z-index: 2000; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); transition: 0.3s; }

#loginOverlay, #pinOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
#pinOverlay { display: none; background: rgba(5, 7, 10, 0.98); }
.login-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; margin-top: 30px; }
.user-btn { background: var(--card); border: 1px solid var(--border); color: white; padding: 20px; border-radius: 15px; cursor: pointer; text-align: center; transition: 0.3s; }
.user-btn:hover { border-color: var(--purple); transform: translateY(-5px); }
.admin-lock { border-color: var(--gold); }
.pin-input { background: #000; border: 2px solid var(--border); color: var(--gold); font-size: 2rem; width: 150px; text-align: center; border-radius: 12px; margin: 20px 0; letter-spacing: 10px; padding: 10px; }

header { background: #010409; padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; z-index:100; }
.season-badge { background: var(--gold); color: #000; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
.sync-status { font-size: 0.6rem; color: var(--accent); display: flex; align-items: center; gap: 5px; }

nav { position: fixed; bottom: 0; left: 0; right: 0; background: #111418; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid var(--border); z-index: 1000; }
nav button { background: none; border: none; color: var(--muted); display: flex; flex-direction: column; align-items: center; font-size: 0.65rem; gap: 5px; cursor: pointer; flex: 1; }
nav button.active { color: var(--accent); }

main { padding: 15px; max-width: 600px; margin: auto; }
.card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 16px; position: relative; }

/* Styles pour le nouvel onglet Hall of Fame */
.hof-card { background: linear-gradient(135deg, #1a1a1a 0%, #000 100%); border: 1px solid var(--gold); text-align: center; padding: 20px; }
.goat-title { color: var(--gold); font-size: 0.7rem; letter-spacing: 2px; font-weight: bold; margin-bottom: 10px; }
.goat-name { font-size: 1.8rem; font-weight: 800; color: #fff; margin-bottom: 5px; }
.season-winner-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #222; font-size: 0.9rem; }

/* Reste des styles originaux */
.awards-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 15px; scrollbar-width: none; }
.award-card { min-width: 130px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; text-align: center; }
.award-winner { font-size: 0.8rem; font-weight: bold; color: var(--gold); display: block; margin-top: 5px; }
table { width: 100%; border-collapse: collapse; }
th { color: var(--muted); font-size: 0.6rem; text-transform: uppercase; padding-bottom: 10px; }
td { padding: 12px 2px; border-bottom: 1px solid #30363d55; font-size: 0.85rem; vertical-align: middle; }
.col-player { text-align: left; padding-left: 5px; width: 35%; }
.col-center { text-align: center; }
.val-badge { background: #1e1b4b; color: var(--blue); padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.7rem; }
.form-container { display: flex; gap: 4px; justify-content: center; }
.dot { width: 9px; height: 9px; border-radius: 50%; }
.win { background: var(--accent); box-shadow: 0 0 5px var(--accent); }
.loss { background: var(--danger); }
.draw { background: var(--muted); }
.duel-bar-container { height: 12px; background: #000; border-radius: 10px; margin: 15px 0; overflow: hidden; display: flex; border: 1px solid var(--border); }
.duel-bar-left { background: var(--blue); height: 100%; transition: width 0.5s ease; border-right: 2px solid #fff; }
.duel-bar-right { background: var(--purple); height: 100%; transition: width 0.5s ease; }
.tactic-badge { background: #1e1b4b; color: var(--blue); padding: 4px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: bold; display: inline-block; margin-bottom: 10px; }
.tactic-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.7rem; }
.tactic-item { background: #0a0c10; padding: 8px; border-radius: 8px; border-left: 3px solid var(--purple); }
.predict-card { background: linear-gradient(135deg, #1e1b4b 0%, #111418 100%); border: 1px solid var(--purple); padding: 20px; margin-bottom:15px; }
.live-predict-card { background: linear-gradient(135deg, #0f172a 0%, #020617 100%); border: 1px solid var(--accent); padding: 15px; }
.brief-box { background: #0a0c10; border-left: 4px solid var(--gold); padding: 12px; margin-top: 10px; font-size: 0.75rem; border-radius: 4px; line-height: 1.4; }
.brief-title { color: var(--gold); font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; font-size: 0.7rem; }
.brief-advice { color: var(--muted); font-style: italic; display: block; margin-top: 5px; border-top: 1px solid #333; padding-top: 5px; }
.match-card { border-bottom: 1px solid var(--border); padding: 15px 0; }
.team-row { display: flex; align-items: center; justify-content: space-between; margin: 8px 0; }
.team-select { background: #000; color: white; border: 1px solid var(--border); border-radius: 8px; padding: 6px; font-size: 0.7rem; width: 110px; }
.score-input { width: 45px; height: 40px; background: #000; border: 1px solid var(--border); color: white; text-align: center; border-radius: 8px; font-weight: bold; font-size: 1.1rem; }
.btn-primary { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; }
.btn-rotation { background: var(--purple); margin-top: 10px; }
.btn-edit { background: none; border: 1px solid var(--blue); color: var(--blue); padding: 4px 8px; border-radius: 6px; font-size: 0.6rem; cursor: pointer; }
.edit-box { background: #000; padding: 15px; border-radius: 10px; margin-top: 10px; border: 1px dashed var(--blue); text-align: center; }
#winnerModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:2000; justify-content:center; align-items:center; text-align:center; padding: 20px; }
.live-match-header { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px; }
.vs-circle { background: var(--border); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; }
</style>
</head>
<body>

<div id="syncNotify"><i class="fas fa-sync-alt fa-spin"></i> Mise √† jour Live...</div>

<div id="loginOverlay">
<i class="fas fa-shield-halved" style="font-size: 3rem; color: var(--purple); margin-bottom: 10px;"></i>
<h2 style="margin:0">FC26 ELITE</h2>
<div class="login-grid">
<div class="user-btn admin-lock" onclick="checkPin()"><i class="fas fa-user-crown" style="color:var(--gold)"></i>ADMIN</div>
<div class="user-btn" onclick="login('BVI')"><i class="fas fa-user"></i>BVI</div>
<div class="user-btn" onclick="login('NAD')"><i class="fas fa-user"></i>NAD</div>
<div class="user-btn" onclick="login('WIL')"><i class="fas fa-user"></i>WIL</div>
<div class="user-btn" onclick="login('BROOK')"><i class="fas fa-user"></i>BROOK</div>
</div>
</div>

<div id="pinOverlay">
<input type="password" id="pinCode" class="pin-input" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
<button class="btn-primary" onclick="validatePin()">OK</button>
</div>

<div id="winnerModal">
<div style="background: var(--card); padding: 40px; border-radius: 30px; border: 2px solid var(--gold);">
<i class="fas fa-trophy" style="font-size: 4rem; color: var(--gold); margin-bottom: 20px;"></i>
<h1 id="winnerName">-</h1>
<button class="btn-primary" onclick="closeWinner()">NOUVELLE SAISON üî•</button>
</div>
</div>

<header>
<div onclick="logout()" style="cursor:pointer"><i class="fas fa-power-off"></i> <span id="userDisplay" style="font-size:0.7rem; color:var(--muted); margin-left:5px"></span></div>
<div style="display:flex; align-items:center; gap:10px">
<div class="sync-status" id="syncStatus"><i class="fas fa-circle" style="font-size:0.5rem"></i> LIVE</div>
<div id="seasonBadge" class="season-badge">Saison 1</div>
</div>
</header>

<main id="app"></main>

<nav>
<button class="active" data-tab="dashboard"><i class="fas fa-chart-line"></i><span>Stats</span></button>
<button data-tab="matches"><i class="fas fa-gamepad"></i><span>Live Match</span></button>
<button data-tab="analysis"><i class="fas fa-brain"></i><span>IA Expert</span></button>
<button data-tab="players"><i class="fas fa-users"></i><span>Effectif</span></button>
<button data-tab="halloffame"><i class="fas fa-trophy"></i><span>Palmar√®s</span></button>
<button data-tab="archives"><i class="fas fa-history"></i><span>Archives</span></button>
</nav>

<script>
const FB_URL = "https://fc26-e596e-default-rtdb.europe-west1.firebasedatabase.app/data.json";
const ADMIN_PIN = "1234";
const TEAMS = ["Real Madrid", "Man City", "Barcelone", "Bayern Munich", "Liverpool", "PSG", "Arsenal", "Inter Milan", "Milan AC", "Atletico", "Leverkusen", "Dortmund", "Juventus", "Naples", "Chelsea", "Aston Villa"];

let currentUser = localStorage.getItem("fc26_user") || null;
let state = { season: 1, players: [], currentDay: [], archives: [], rotationQueue: [] };
let isInteracting = false;

const notifySound = new Audio("https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3");
const qs = (s) => document.querySelector(s);
const isAdmin = () => currentUser === 'ADMIN';

async function pushData() { if (isAdmin()) { try { await fetch(FB_URL, { method: 'PUT', body: JSON.stringify(state) }); } catch (e) {} } }
async function pullData() {
if (isInteracting) return;
try {
const res = await fetch(FB_URL);
const data = await res.json();
if (data && JSON.stringify(data) !== JSON.stringify(state)) {
state = data; render(); showNotify(); qs('#seasonBadge').innerText = `SAISON ${state.season}`;
}
} catch (e) {}
}

function showNotify() { const n = qs("#syncNotify"); n.style.display = "block"; notifySound.play().catch(e => {}); setTimeout(() => { n.style.display = "none"; }, 3000); }
setInterval(pullData, 5000);

function checkPin() { qs('#pinOverlay').style.display = 'flex'; qs('#pinCode').focus(); }
function validatePin() { if(qs('#pinCode').value === ADMIN_PIN) { qs('#pinOverlay').style.display = 'none'; login('ADMIN'); } else { alert("PIN Incorrect"); } }
function login(user) { currentUser = user; localStorage.setItem("fc26_user", user); qs('#loginOverlay').style.display = 'none'; qs('#userDisplay').innerText = user; pullData(); }
function logout() { localStorage.removeItem("fc26_user"); location.reload(); }
if(currentUser) login(currentUser);
function save() { if(isAdmin()) pushData(); render(); }

// --- LOGIQUE HALL OF FAME ---
function getWinnersPerSeason() {
    if (!state.archives) return [];
    let seasonData = {};
    
    state.archives.flat().forEach(m => {
        if (!seasonData[m.seasonRef]) seasonData[m.seasonRef] = {};
        if (!seasonData[m.seasonRef][m.p1]) seasonData[m.seasonRef][m.p1] = 0;
        if (!seasonData[m.seasonRef][m.p2]) seasonData[m.seasonRef][m.p2] = 0;
        
        if (m.s1 > m.s2) seasonData[m.seasonRef][m.p1] += 3;
        else if (m.s2 > m.s1) seasonData[m.seasonRef][m.p2] += 3;
        else { seasonData[m.seasonRef][m.p1] += 1; seasonData[m.seasonRef][m.p2] += 1; }
    });

    let finalWinners = [];
    Object.keys(seasonData).forEach(sNum => {
        let players = seasonData[sNum];
        let winner = Object.keys(players).reduce((a, b) => players[a] > players[b] ? a : b);
        finalWinners.push({ season: sNum, winner: winner });
    });
    return finalWinners.reverse();
}

function getGOAT() {
    const winners = getWinnersPerSeason();
    if (winners.length === 0) return { name: "Aucun", titles: 0 };
    let counts = {};
    winners.forEach(w => counts[w.winner] = (counts[w.winner] || 0) + 1);
    let goat = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
    return { name: goat, titles: counts[goat], all: counts };
}

// --- CALCULS ORIGINAUX ---
function calculateValue(p) { return (10 + (p.points * 1.5) + ((p.gf - p.ga) * 0.5)).toFixed(1); }
function getAllTimeStats() {
let stats = {}; if(!state.archives) return stats;
state.archives.flat().forEach(m => {
if(!stats[m.p1]) stats[m.p1] = { gf:0, ga:0, pts:0, games:0 };
if(!stats[m.p2]) stats[m.p2] = { gf:0, ga:0, pts:0, games:0 };
stats[m.p1].gf += m.s1; stats[m.p1].ga += m.s2; stats[m.p1].games++;
stats[m.p2].gf += m.s2; stats[m.p2].ga += m.s1; stats[m.p2].games++;
if(m.s1 > m.s2) stats[m.p1].pts += 3; else if(m.s2 > m.s1) stats[m.p2].pts += 3; else { stats[m.p1].pts++; stats[m.p2].pts++; }
});
return stats;
}
function getLivePrediction() {
if(!state.players || state.players.length === 0) return null;
let scores = state.players.map(p => {
let power = p.points + ((p.gf - p.ga) * 0.5);
return { name: p.name, power: power };
});
scores.sort((a,b) => b.power - a.power);
let totalPower = scores.reduce((acc, curr) => acc + Math.max(0.1, curr.power), 0);
let top = scores[0];
let proba = Math.round((Math.max(0.1, top.power) / (totalPower || 1)) * 100);
return { name: top.name, proba: proba };
}
function getSeasonRecord() {
let record = { name: "-", goals: 0, season: 0 }; if(!state.archives) return record;
const seasons = {};
state.archives.flat().forEach(m => {
const key1 = `S${m.seasonRef}_${m.p1}`; const key2 = `S${m.seasonRef}_${m.p2}`;
seasons[key1] = (seasons[key1] || 0) + m.s1; seasons[key2] = (seasons[key2] || 0) + m.s2;
});
Object.keys(seasons).forEach(k => { if(seasons[k] > record.goals) { record.goals = seasons[k]; record.name = k.split('_')[1]; record.season = k.split('_')[0]; } });
return record;
}
function getForm(name) {
const history = []; const allMatches = state.archives ? state.archives.flat() : [];
[...allMatches].reverse().forEach(m => {
if((m.p1 === name || m.p2 === name) && history.length < 5) {
const win = (m.p1 === name) ? m.s1 > m.s2 : m.s2 > m.s1;
const draw = m.s1 === m.s2;
history.push(win ? 'win' : (draw ? 'draw' : 'loss'));
}
});
return history;
}
function getPrediction() {
const allTime = getAllTimeStats(); if (Object.keys(allTime).length === 0) return { name: "N/A", proba: 0 };
let best = Object.keys(allTime).reduce((a, b) => (allTime[a]?.pts||0) > (allTime[b]?.pts||0) ? a : b);
let total = Object.values(allTime).reduce((a, b) => a + (b.pts||0), 0);
return { name: best, proba: Math.round(((allTime[best]?.pts||0)/(total||1))*100) };
}
function getTactic(playerName) {
const stats = getAllTimeStats()[playerName] || {gf:0, ga:0, games:1};
const avgGf = stats.gf / stats.games; const avgGa = stats.ga / stats.games;
if(avgGf > 2.5) return { form: "4-3-3 OFFENSIF", style: "Construction Rapide", def: "Pressing Constant", width: "65 / 70", role: "Faux 9 / Ailiers Int√©rieurs" };
if(avgGa < 1.5) return { form: "5-2-1-2", style: "Contre-Attaque", def: "Reculer", width: "40 / 30", role: "Piston Offensif" };
return { form: "4-2-3-1 (2)", style: "√âquilibr√©", def: "√âquilibr√©", width: "50 / 50", role: "MOC Libre / Pivot" };
}
function getMatchBriefing(p1Name, p2Name) {
const allMatches = state.archives ? state.archives.flat() : [];
let headToHead = { p1Wins: 0, p2Wins: 0, draws: 0, p1Goals: 0, p2Goals: 0 };
allMatches.forEach(m => {
if(m.p1 === p1Name && m.p2 === p2Name) {
if(m.s1 > m.s2) headToHead.p1Wins++; else if(m.s2 > m.s1) headToHead.p2Wins++; else headToHead.draws++;
headToHead.p1Goals += m.s1; headToHead.p2Goals += m.s2;
} else if(m.p1 === p2Name && m.p2 === p1Name) {
if(m.s2 > m.s1) headToHead.p1Wins++; else if(m.s1 > m.s2) headToHead.p2Wins++; else headToHead.draws++;
headToHead.p1Goals += m.s2; headToHead.p2Goals += m.s1;
}
});
const totalGames = headToHead.p1Wins + headToHead.p2Wins + headToHead.draws;
if(totalGames === 0) return { analysis: "Aucun duel historique enregistr√©.", advice: "Premier round psychologique !" };
let analysis = headToHead.p1Wins > headToHead.p2Wins ? `**${p1Name}** domine historiquement (${headToHead.p1Wins} victoires). ` : (headToHead.p2Wins > headToHead.p1Wins ? `**${p2Name}** a l'ascendant (${headToHead.p2Wins} victoires). ` : "√âquilibre parfait entre ces deux rivaux. ");
let advice = headToHead.p1Goals > headToHead.p2Goals ? `**${p2Name}** doit surveiller ses contres.` : "Match qui s'annonce tr√®s tactique.";
return { analysis, advice };
}

// --- RENDU ---
function render() {
const tab = qs("nav button.active").dataset.tab;
const app = qs("#app"); app.innerHTML = "";

if (tab === "dashboard") {
const sorted = [...state.players].sort((a,b) => b.points - a.points || (b.gf-b.ga)-(a.gf-a.ga));
const pichichi = [...state.players].sort((a,b) => b.gf - a.gf)[0];
const defense = [...state.players].sort((a,b) => a.ga - b.ga)[0];
const topVal = sorted.length ? [...state.players].sort((a,b) => calculateValue(b) - calculateValue(a))[0] : null;

app.innerHTML = `<div id="pdf-area">
<div class="awards-scroll">
<div class="award-card">‚öΩ <div class="award-winner">${pichichi?.name || '-'}</div><div style="font-size:0.5rem">PICHICHI</div></div>
<div class="award-card">üõ°Ô∏è <div class="award-winner">${defense?.name || '-'}</div><div style="font-size:0.5rem">LE ROC</div></div>
<div class="award-card">üíé <div class="award-winner">${topVal ? calculateValue(topVal) : '0'}M</div><div style="font-size:0.5rem">VALEUR TOP</div></div>
</div>
<div style="display:flex; justify-content:space-between; margin:15px 0">
<h3>Classement S${state.season}</h3>
<button class="btn-primary" style="width:auto; padding:5px 15px; font-size:0.7rem" onclick="exportPDF()">PDF</button>
</div>
<div class="card">
<table>
<thead>
<tr><th class="col-player">Joueur</th><th class="col-center">Pts</th><th class="col-center">GD</th><th class="col-center">Valeur</th><th class="col-center">Forme</th></tr>
</thead>
<tbody>
${sorted.map(p => {
const gd = p.gf - p.ga;
return `<tr>
<td class="col-player"><strong>${p.name}</strong></td>
<td class="col-center" style="color:var(--blue); font-weight:bold">${p.points}</td>
<td class="col-center" style="color:${gd >= 0 ? 'var(--accent)' : 'var(--danger)'}; font-size:0.75rem">${gd > 0 ? '+'+gd : gd}</td>
<td class="col-center"><span class="val-badge">${calculateValue(p)}M</span></td>
<td class="col-center"><div class="form-container">${getForm(p.name).map(f => `<div class="dot ${f}"></div>`).join('')}</div></td>
</tr>`}).join('')}
</tbody>
</table>
</div>
</div>${isAdmin() ? `<button class="btn-primary" style="background:var(--danger); margin-top:10px" onclick="finishSeason()">TERMINER LA SAISON</button>` : ''}`;
}

if (tab === "matches") {
if (!state.currentDay || state.currentDay.length === 0) {
let rotationBtn = (isAdmin() && state.players.length === 3) ? `<button class="btn-primary btn-rotation" onclick="startWinnerStays()">ACTIVER LE MODE ROTATION (3 JOUEURS) üîÑ</button>` : '';
app.innerHTML = `<div class="card" style="text-align:center; padding:40px; border: 2px dashed var(--border)">
<i class="fas fa-gamepad" style="font-size:3rem; color:var(--muted); margin-bottom:20px"></i>
<p style="color:var(--muted)">Aucun match en cours sur le terrain.</p>
${isAdmin() ? `<button class="btn-primary" onclick="startDay()">LANCER UNE JOURN√âE CLASSIQUE ‚öΩ</button> ${rotationBtn}` : `<p>L'Admin doit lancer la session.</p>`}
</div>`;
} else {
const activeMatchIdx = state.currentDay.findIndex(m => !m.done);
const m = state.currentDay[activeMatchIdx] || state.currentDay[state.currentDay.length-1];
app.innerHTML = `<h3>En Direct üèüÔ∏è</h3>`;
if(!m.done) {
const brief = getMatchBriefing(m.p1, m.p2);
app.innerHTML += `<div class="card" style="border: 2px solid var(--accent)">
<div style="text-align:center; color:var(--accent); font-size:0.6rem; font-weight:bold; margin-bottom:15px"><i class="fas fa-play-circle"></i> MATCH EN COURS</div>
<div class="team-row">
<div style="flex:1; text-align:right"><strong>${m.p1}</strong><br>
<select class="team-select" id="t1_${activeMatchIdx}" ${!isAdmin()?'disabled':''}>${TEAMS.map(t => `<option value="${t}" ${m.team1==t?'selected':''}>${t}</option>`).join('')}</select>
</div>
<input type="number" id="s1_${activeMatchIdx}" class="score-input" placeholder="-" ${!isAdmin()?'disabled':''} style="margin: 0 10px">
<div class="vs-circle">VS</div>
<input type="number" id="s2_${activeMatchIdx}" class="score-input" placeholder="-" ${!isAdmin()?'disabled':''} style="margin: 0 10px">
<div style="flex:1; text-align:left"><strong>${m.p2}</strong><br>
<select class="team-select" id="t2_${activeMatchIdx}" ${!isAdmin()?'disabled':''}>${TEAMS.map(t => `<option value="${t}" ${m.team2==t?'selected':''}>${t}</option>`).join('')}</select>
</div>
</div>
${isAdmin() ? `<button class="btn-primary" style="margin-top:20px" onclick="validateMatch(${activeMatchIdx})">VALIDER LE R√âSULTAT ‚úÖ</button>` : ''}
<div class="brief-box">
<div class="brief-title"><i class="fas fa-robot"></i> ANALYSE IA</div>
${brief.analysis.replace(/\*\*/g, '<b>').replace(/\*\*/g, '</b>')}
<span class="brief-advice">${brief.advice.replace(/\*\*/g, '<b>').replace(/\*\*/g, '</b>')}</span>
</div>
</div>`;
}
}
}

if (tab === "halloffame") {
    const winners = getWinnersPerSeason();
    const goat = getGOAT();
    
    app.innerHTML = `<h3>üèÜ Hall of Fame</h3>`;
    
    // Carte du GOAT
    app.innerHTML += `
    <div class="card hof-card">
        <div class="goat-title">LE PLUS TITR√â (GOAT)</div>
        <i class="fas fa-crown" style="color:var(--gold); font-size:2rem; margin-bottom:10px"></i>
        <div class="goat-name">${goat.name}</div>
        <div style="color:var(--muted); font-size:0.8rem">${goat.titles} Titre(s) de Champion</div>
    </div>`;

    // Top Gagnants
    app.innerHTML += `
    <div class="card">
        <strong>ü•á CLASSEMENT DES CHAMPIONS</strong>
        <div style="margin-top:10px">
            ${Object.entries(goat.all).sort((a,b) => b[1] - a[1]).map(([name, count]) => `
                <div style="display:flex; justify-content:space-between; padding:5px 0">
                    <span>${name}</span>
                    <span style="color:var(--gold); font-weight:bold">${count} üèÜ</span>
                </div>
            `).join('')}
        </div>
    </div>`;

    // Liste par saison
    app.innerHTML += `
    <div class="card">
        <strong>üìÖ HISTORIQUE DES SAISONS</strong>
        <div style="margin-top:10px">
            ${winners.map(w => `
                <div class="season-winner-row">
                    <span style="color:var(--muted)">Saison ${w.season}</span>
                    <span style="font-weight:bold; color:var(--blue)">${w.winner}</span>
                </div>
            `).join('')}
        </div>
    </div>`;
}

if (tab === "analysis") {
const allTime = getAllTimeStats();
const pred = getPrediction();
const livePred = getLivePrediction();
const seasonRecord = getSeasonRecord();
const playersByGoals = Object.keys(allTime).sort((a,b) => allTime[b].gf - allTime[a].gf);
const playersByDef = Object.keys(allTime).sort((a,b) => (allTime[a].ga/allTime[a].games) - (allTime[b].ga/allTime[b].games));

app.innerHTML = `<h3>üß† Analyse IA Expert</h3>
<div class="card live-predict-card">
<div style="color:var(--accent); font-size:0.7rem; font-weight:bold"><i class="fas fa-chart-line"></i> PR√âDICTION TITRE (SAISON ${state.season})</div>
<div style="font-size:1.6rem; font-weight:700; margin:5px 0">${livePred ? livePred.name : '-'}</div>
<div style="display:flex; align-items:center; gap:10px">
<div style="flex:1; height:6px; background:#000; border-radius:10px; overflow:hidden"><div style="width:${livePred ? livePred.proba : 0}%; height:100%; background:var(--accent)"></div></div>
<span style="font-weight:bold">${livePred ? livePred.proba : 0}%</span>
</div>
</div>
<div class="card predict-card">
<div style="color:var(--purple); font-size:0.7rem">FAVORI HISTORIQUE (ALL-TIME) üî•</div>
<div style="font-size:1.4rem; font-weight:700; margin:10px 0">${pred.name}</div>
<div style="display:flex; align-items:center; gap:10px">
<div style="flex:1; height:6px; background:#000; border-radius:10px; overflow:hidden"><div style="width:${pred.proba}%; height:100%; background:var(--purple)"></div></div>
<span>${pred.proba}%</span>
</div>
</div>
<div class="card"><strong>üìã CONSEIL TACTIQUE</strong><select id="tacticPlayer" class="team-select" style="width:100%; margin-top:10px" onchange="renderTacticAdvice()"><option value="">Choisir un joueur...</option>${state.players.map(p => `<option value="${p.name}">${p.name}</option>`).join('')}</select><div id="tacticResult"></div></div>
<div class="card"><strong>‚öîÔ∏è COMPARATEUR</strong><div style="display:flex; gap:10px; margin-top:10px"><select id="duel1" class="team-select" style="flex:1" onchange="renderDuelAnalysis()"><option value="">Joueur 1</option>${state.players.map(p => `<option value="${p.name}">${p.name}</option>`).join('')}</select><select id="duel2" class="team-select" style="flex:1" onchange="renderDuelAnalysis()"><option value="">Joueur 2</option>${state.players.map(p => `<option value="${p.name}">${p.name}</option>`).join('')}</select></div><div id="duelResult"></div></div>
<div class="card"><strong>üèÜ PANTH√âON</strong><div class="stat-row"><span class="stat-label">‚öΩ BUTEUR ALL-TIME</span><span class="stat-value">${playersByGoals[0] || '-'} (${allTime[playersByGoals[0]]?.gf || 0} buts)</span></div><div class="stat-row"><span class="stat-label">üõ°Ô∏è MEILLEURE D√âFENSE</span><span class="stat-value">${playersByDef[0] || '-'}</span></div><div class="stat-row"><span class="stat-label">üî• RECORD / SAISON</span><span class="stat-value">${seasonRecord.name} (${seasonRecord.goals})</span></div></div>`;
}

if (tab === "players") {
app.innerHTML = `<h3>Effectif üë•</h3>${isAdmin() ? `<div class="card"><div style="display:flex; gap:10px"><input id="pName" placeholder="Nom..." style="flex:1; background:#000; border:1px solid var(--border); color:white; padding:12px; border-radius:10px"><button class="btn-primary" style="width:auto" onclick="addPlayer()">+</button></div></div>` : ''}${state.players.map(p => `<div class="card" style="display:flex; justify-content:space-between; align-items:center"><div><strong>${p.name}</strong><br><small style="color:var(--blue)">${calculateValue(p)} M‚Ç¨ (Pts: ${p.points})</small></div>${isAdmin() ? `<div style="display:flex; gap:12px"><button onclick="rewardPlayer('${p.id}')" style="background:none; border:none; color:var(--accent); cursor:pointer"><i class="fas fa-plus-circle"></i></button><button onclick="penalizePlayer('${p.id}')" style="background:none; border:none; color:var(--gold); cursor:pointer"><i class="fas fa-minus-circle"></i></button><button onclick="removePlayer('${p.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer"><i class="fas fa-trash"></i></button></div>` : ''}</div>`).join('')}${isAdmin() ? `<button class="btn-primary" style="background:var(--danger); margin-top:30px" onclick="initSystem()">‚ö†Ô∏è R√âINITIALISER TOUT</button>` : ''}`;
}

if (tab === "archives") {
app.innerHTML = `<h3>üìÇ Archives Sessions</h3>`;
if(!state.archives) return;
const grouped = {}; state.archives.forEach((d, globalIdx) => {
const sRef = d[0].seasonRef;
if(!grouped[sRef]) grouped[sRef] = [];
grouped[sRef].push({day: d, idx: globalIdx});
});
Object.keys(grouped).sort((a,b) => b-a).forEach(s => {
app.innerHTML += `<div class="card"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px"><div style="color:var(--gold); font-weight:bold">SAISON ${s}</div>${isAdmin() ? `<button onclick="deleteSeason(${s})" style="background:none; border:none; color:var(--danger); cursor:pointer"><i class="fas fa-trash-alt"></i></button>` : ''}</div>${grouped[s].map((item, di) => `<details style="margin-bottom:8px"><summary style="color:var(--blue); font-size:0.8rem">Session du ${item.day[0].date}</summary><div style="font-size:0.75rem; padding:10px">${item.day.map((m, mIdx) => `<div style="display:flex; justify-content:space-between; margin-bottom:5px; border-bottom:1px solid #222">${m.p1} <b>${m.s1}-${m.s2}</b> ${m.p2} ${isAdmin() ? `<button class="btn-edit" onclick="editOldMatch(${item.idx}, ${mIdx})">Edit</button>` : ''}</div><div id="edit_${item.idx}_${mIdx}"></div>`).join('')}</div></details>`).join('')}</div>`;
});
}
}

// Fonctions Match & Rotation
function startWinnerStays() {
if(isAdmin() && state.players.length === 3) {
const names = state.players.map(p => p.name);
state.rotationQueue = [names[2]];
state.currentDay = [{ p1: names[0], p2: names[1], s1: null, s2: null, done: false, seasonRef: state.season, date: new Date().toLocaleDateString('fr-FR'), team1: "Real Madrid", team2: "Man City" }];
save();
}
}
function handleRotation(lastMatch) {
const winner = lastMatch.s1 > lastMatch.s2 ? lastMatch.p1 : (lastMatch.s2 > lastMatch.s1 ? lastMatch.p2 : lastMatch.p1);
const loser = winner === lastMatch.p1 ? lastMatch.p2 : lastMatch.p1;
const waiting = state.rotationQueue.shift();
state.rotationQueue.push(loser);
state.currentDay.push({ p1: winner, p2: waiting, s1: null, s2: null, done: false, seasonRef: state.season, date: new Date().toLocaleDateString('fr-FR'), team1: "Real Madrid", team2: "Man City" });
}
function validateMatch(i){
if(isAdmin()){
const s1=parseInt(qs(`#s1_${i}`).value), s2=parseInt(qs(`#s2_${i}`).value);
if(isNaN(s1)||isNaN(s2)) return;
const m=state.currentDay[i];
const p1=state.players.find(p=>p.name===m.p1), p2=state.players.find(p=>p.name===m.p2);
p1.gf+=s1; p1.ga+=s2; p2.gf+=s2; p2.ga+=s1;
if(s1>s2) p1.points+=3; else if(s2>s1) p2.points+=3; else {p1.points+=1; p2.points+=1;}
m.s1=s1; m.s2=s2; m.done=true;
m.team1=qs(`#t1_${i}`).value; m.team2=qs(`#t2_${i}`).value;
if(state.rotationQueue && state.rotationQueue.length > 0) handleRotation(m);
if(state.currentDay.every(x=>x.done)){
if(!state.archives) state.archives=[];
state.archives.push([...state.currentDay]);
state.currentDay=[]; state.rotationQueue = [];
}
isInteracting = false; save();
}
}

function rewardPlayer(id) { if(isAdmin()) { const p = state.players.find(x => x.id === id); const pts = prompt(`Points pour ${p.name} ?`); if(pts) { p.points += parseInt(pts); save(); } } }
function penalizePlayer(id) { if(isAdmin()) { const p = state.players.find(x => x.id === id); const pts = prompt(`Retirer points √† ${p.name} ?`); if(pts) { p.points -= parseInt(pts); save(); } } }
function deleteSeason(sNum) { if(isAdmin() && confirm("Supprimer ?")) { state.archives = state.archives.filter(day => day[0].seasonRef != sNum); save(); } }
function initSystem() { if(isAdmin() && confirm("Reset ?")){ state.season = 1; state.archives = []; state.currentDay = []; state.players.forEach(p => {p.points=0; p.gf=0; p.ga=0;}); save(); } }
function renderTacticAdvice() { isInteracting = true; const p = qs("#tacticPlayer").value; const res = qs("#tacticResult"); if(!p) return; const t = getTactic(p); res.innerHTML = `<div style="margin-top:15px"><div class="tactic-badge">${t.form}</div><div class="tactic-grid"><div class="tactic-item">Style: <b>${t.style}</b></div><div class="tactic-item">D√©f: <b>${t.def}</b></div></div><button class="btn-primary" style="margin-top:10px; font-size:0.6rem" onclick="isInteracting=false; render()">FIN</button></div>`; }
function renderDuelAnalysis() { isInteracting = true; const p1 = qs("#duel1").value, p2 = qs("#duel2").value; const stats = getAllTimeStats(); if(!p1 || !p2 || p1 === p2) return; const s1 = stats[p1] || {pts:0, games:1}, s2 = stats[p2] || {pts:0, games:1}; const r = ((s1.pts/s1.games) / ((s1.pts/s1.games)+(s2.pts/s2.games)||1)) * 100; qs("#duelResult").innerHTML = `<div class="duel-bar-container"><div class="duel-bar-left" style="width:${r}%"></div><div class="duel-bar-right" style="width:${100-r}%"></div></div><button class="btn-primary" style="font-size:0.6rem" onclick="isInteracting=false; render()">FIN</button>`; }
function addPlayer(){ if(isAdmin()){ const n=qs("#pName").value.trim(); if(n){state.players.push({id:crypto.randomUUID(), name:n, points:0, gf:0, ga:0}); save();}} }
function removePlayer(id){ if(isAdmin() && confirm("Supprimer ?")){ state.players=state.players.filter(p=>p.id!==id); save(); } }
function startDay(){ if(isAdmin() && state.players.length >= 2){ state.rotationQueue = []; state.currentDay=[]; for(let i=0; i<state.players.length; i++) for(let j=i+1; j<state.players.length; j++) state.currentDay.push({p1:state.players[i].name, p2:state.players[j].name, s1:null, s2:null, done:false, seasonRef:state.season, date:new Date().toLocaleDateString('fr-FR'), team1:"Real Madrid", team2:"Man City"}); save(); } }
function finishSeason(){ if(isAdmin()){ const s=[...state.players].sort((a,b)=>b.points-a.points); if(s.length){qs("#winnerName").innerText=s[0].name; qs("#winnerModal").style.display="flex";} save(); } }
function closeWinner(){ state.season++; state.players.forEach(p=>{p.points=0; p.gf=0; p.ga=0;}); state.currentDay=[]; state.rotationQueue=[]; qs("#winnerModal").style.display="none"; save(); }
function exportPDF(){ html2pdf().from(qs('#pdf-area')).set({filename:`FC26_S${state.season}.pdf`, html2canvas:{scale:2, backgroundColor:'#05070a'}}).save(); }

document.querySelectorAll("nav button").forEach(btn => { btn.onclick = () => { isInteracting = false; document.querySelectorAll("nav button").forEach(b=>b.classList.remove('active')); btn.classList.add('active'); render(); }; });
pullData();
</script>
</body>
</html>
