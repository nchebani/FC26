<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>FC26 Manager - Elite Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg: #05070a; --card: #111418; --border: #30363d;
            --accent: #238636; --blue: #58a6ff; --gold: #d4af37;
            --silver: #bec2cb; --bronze: #cd7f32;
            --text: #f8fafc; --muted: #8b949e; --danger: #da3633;
            --purple: #8957e5;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 90px; }

        #syncNotify { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: var(--purple); color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; z-index: 2000; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }

        #loginOverlay, #pinOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        #pinOverlay { display: none; background: rgba(5, 7, 10, 0.98); }
        .login-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; margin-top: 30px; }
        .user-btn { background: var(--card); border: 1px solid var(--border); color: white; padding: 20px; border-radius: 15px; cursor: pointer; text-align: center; transition: 0.3s; }
        .admin-lock { border-color: var(--gold); }
        .pin-input { background: #000; border: 2px solid var(--border); color: var(--gold); font-size: 2rem; width: 150px; text-align: center; border-radius: 12px; margin: 20px 0; letter-spacing: 10px; padding: 10px; }

        header { background: #010409; padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; z-index:100; }
        .season-badge { background: var(--gold); color: #000; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        
        nav { position: fixed; bottom: 0; left: 0; right: 0; background: #111418; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid var(--border); z-index: 1000; }
        nav button { background: none; border: none; color: var(--muted); display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; gap: 5px; cursor: pointer; }
        nav button.active { color: var(--accent); }

        main { padding: 15px; max-width: 600px; margin: auto; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 16px; position: relative; }

        .badge-container { display: flex; gap: 5px; margin-top: 4px; flex-wrap: wrap; }
        .prestige-badge { font-size: 0.55rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; display: flex; align-items: center; gap: 3px; }
        .badge-sniper { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
        .badge-mur { background: #dcfce7; color: #166534; border: 1px solid #22c55e; }

        .medal-card { display: flex; align-items: center; gap: 15px; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid transparent; }
        .medal-gold { background: linear-gradient(90deg, #d4af3722, transparent); border-left-color: var(--gold); }
        .medal-silver { background: linear-gradient(90deg, #bec2cb22, transparent); border-left-color: var(--silver); }

        table { width: 100%; border-collapse: collapse; }
        th { color: var(--muted); font-size: 0.6rem; text-transform: uppercase; padding-bottom: 10px; }
        td { padding: 12px 2px; border-bottom: 1px solid #30363d55; font-size: 0.85rem; }
        .col-player { text-align: left; width: 40%; }
        .col-center { text-align: center; }

        .val-badge { background: #1e1b4b; color: var(--blue); padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.7rem; }
        .form-container { display: flex; gap: 4px; justify-content: center; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .win { background: var(--accent); } .loss { background: var(--danger); } .draw { background: var(--muted); }

        .brief-box { background: #0a0c10; border-left: 4px solid var(--gold); padding: 12px; margin-top: 10px; font-size: 0.75rem; border-radius: 4px; }
        .match-card { border-bottom: 1px solid var(--border); padding: 15px 0; }
        .team-row { display: flex; align-items: center; justify-content: space-between; margin: 8px 0; }
        .score-input { width: 45px; height: 35px; background: #000; border: 1px solid var(--border); color: white; text-align: center; border-radius: 8px; font-weight: bold; }
        .btn-primary { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        #winnerModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:2000; justify-content:center; align-items:center; text-align:center; }
    </style>
</head>
<body>

<div id="syncNotify"><i class="fas fa-sync-alt fa-spin"></i> Live...</div>

<div id="loginOverlay">
    <h2 style="margin-bottom:30px">FC26 ELITE</h2>
    <div class="login-grid">
        <div class="user-btn admin-lock" onclick="checkPin()"><i class="fas fa-crown"></i><br>ADMIN</div>
        <div class="user-btn" onclick="login('BVI')">BVI</div>
        <div class="user-btn" onclick="login('NAD')">NAD</div>
        <div class="user-btn" onclick="login('WIL')">WIL</div>
        <div class="user-btn" onclick="login('BROOK')">BROOK</div>
    </div>
</div>

<div id="pinOverlay">
    <input type="password" id="pinCode" class="pin-input" maxlength="4" placeholder="â€¢â€¢â€¢â€¢">
    <button class="btn-primary" onclick="validatePin()">ACCÃ‰DER</button>
</div>

<div id="winnerModal">
    <div style="background: var(--card); padding: 40px; border-radius: 30px; border: 2px solid var(--gold);">
        <i class="fas fa-trophy" style="font-size: 4rem; color: var(--gold);"></i>
        <h1 id="winnerName">-</h1>
        <button class="btn-primary" onclick="closeWinner()">NOUVELLE SAISON ðŸ”¥</button>
    </div>
</div>

<header>
    <div onclick="logout()" style="cursor:pointer"><i class="fas fa-power-off"></i> <span id="userDisplay" style="font-size:0.7rem; margin-left:5px"></span></div>
    <div id="seasonBadge" class="season-badge">Saison 1</div>
</header>

<main id="app"></main>

<nav>
    <button class="active" data-tab="dashboard"><i class="fas fa-chart-line"></i><span>Stats</span></button>
    <button data-tab="analysis"><i class="fas fa-brain"></i><span>IA</span></button>
    <button data-tab="matches"><i class="fas fa-gamepad"></i><span>Jouer</span></button>
    <button data-tab="players"><i class="fas fa-users"></i><span>Joueurs</span></button>
    <button data-tab="hof"><i class="fas fa-crown"></i><span>H.O.F</span></button>
</nav>

<script>
const FB_URL = "https://fc26-e596e-default-rtdb.europe-west1.firebasedatabase.app/data.json";
const ADMIN_PIN = "1234";
const TEAMS = ["Real Madrid", "Man City", "Barcelone", "Bayern Munich", "Liverpool", "PSG", "Arsenal", "Inter Milan", "Milan AC", "Atletico", "Leverkusen", "Dortmund"];

let currentUser = localStorage.getItem("fc26_user") || null;
let state = { season: 1, players: [], currentDay: [], archives: [] };
let isInteracting = false;

const qs = (s) => document.querySelector(s);
const isAdmin = () => currentUser === 'ADMIN';

async function pushData() { if (isAdmin()) await fetch(FB_URL, { method: 'PUT', body: JSON.stringify(state) }); }
async function pullData() {
    if (isInteracting) return;
    try {
        const res = await fetch(FB_URL);
        const data = await res.json();
        if (data && JSON.stringify(data) !== JSON.stringify(state)) {
            state = data; 
            render(); 
            qs('#seasonBadge').innerText = `SAISON ${state.season}`;
        }
    } catch (e) {}
}

setInterval(pullData, 5000);

// --- AUTH ---
function checkPin() { qs('#pinOverlay').style.display = 'flex'; qs('#pinCode').focus(); }
function validatePin() { if(qs('#pinCode').value === ADMIN_PIN) { qs('#pinOverlay').style.display = 'none'; login('ADMIN'); } else { alert("Code erronÃ©"); } }
function login(user) { currentUser = user; localStorage.setItem("fc26_user", user); qs('#loginOverlay').style.display = 'none'; qs('#userDisplay').innerText = user; pullData(); render(); }
function logout() { localStorage.removeItem("fc26_user"); location.reload(); }
if(currentUser) login(currentUser);

function save() { if(isAdmin()) pushData(); render(); }

// --- LOGIQUE CALCULS ---
function calculateValue(p) { 
    return (10 + (parseInt(p.points)||0)*1.5 + ((parseInt(p.gf)||0)-(parseInt(p.ga)||0))*0.5).toFixed(1); 
}

function getForm(name) {
    const history = []; const all = state.archives ? state.archives.flat() : [];
    [...all].reverse().forEach(m => {
        if((m.p1 === name || m.p2 === name) && history.length < 5) {
            const win = (m.p1 === name) ? m.s1 > m.s2 : m.s2 > m.s1;
            history.push(m.s1 === m.s2 ? 'draw' : (win ? 'win' : 'loss'));
        }
    });
    return history;
}

function getPlayerBadges(p) {
    const b = [];
    if ((parseInt(p.gf)/Math.max(1, parseInt(p.points)/3)) > 3.5) b.push({class:'badge-sniper', icon:'fa-crosshairs', label:'Sniper'});
    if (parseInt(p.cs) > 2) b.push({class:'badge-mur', icon:'fa-user-shield', label:'Mur'});
    return b;
}

// --- RENDERING ---
function render() {
    const tab = qs("nav button.active").dataset.tab;
    const app = qs("#app"); app.innerHTML = "";

    if (tab === "dashboard") {
        const sorted = [...state.players].sort((a,b) => b.points - a.points || (b.gf-b.ga)-(a.gf-a.ga));
        app.innerHTML = `<h3>Classement</h3>
            <div class="card">
                <table>
                <thead><tr><th class="col-player">Joueur</th><th class="col-center">Pts</th><th class="col-center">Valeur</th><th class="col-center">Forme</th></tr></thead>
                <tbody>
                ${sorted.map(p => `<tr>
                    <td class="col-player"><strong>${p.name}</strong><div class="badge-container">${getPlayerBadges(p).map(x => `<span class="prestige-badge ${x.class}"><i class="fas ${x.icon}"></i></span>`).join('')}</div></td>
                    <td class="col-center" style="color:var(--blue); font-weight:bold">${p.points}</td>
                    <td class="col-center"><span class="val-badge">${calculateValue(p)}M</span></td>
                    <td class="col-center"><div class="form-container">${getForm(p.name).map(f => `<div class="dot ${f}"></div>`).join('')}</div></td>
                </tr>`).join('')}
                </tbody>
                </table>
            </div>
            ${isAdmin() ? `<button class="btn-primary" style="background:var(--danger)" onclick="finishSeason()">TERMINER LA SAISON</button>` : ''}`;
    }

    if (tab === "analysis") {
        app.innerHTML = `<h3>Analyse IA</h3>`;
        state.players.forEach(p => {
            const form = getForm(p.name).filter(f => f==='win').length;
            app.innerHTML += `<div class="card"><strong>${p.name}</strong><div class="brief-box">${form >= 3 ? "Grande forme offensive." : "Doit stabiliser sa dÃ©fense."}</div></div>`;
        });
    }

    if (tab === "matches") {
        if (!state.currentDay || state.currentDay.length === 0) {
            app.innerHTML = `<div class="card" style="text-align:center">${isAdmin() ? `<button class="btn-primary" onclick="startDay()">GÃ‰NÃ‰RER JOURNÃ‰E</button>` : `<p>Attente de l'admin...</p>`}</div>`;
        } else {
            app.innerHTML = `<h3>Matchs Live</h3><div class="card">${state.currentDay.map((m, i) => `
                <div class="match-card">
                    <div class="team-row"><span>${m.p1}</span><input type="number" id="s1_${i}" class="score-input" value="${m.s1??''}" ${m.done || !isAdmin()?'disabled':''}></div>
                    <div class="team-row"><span>${m.p2}</span><input type="number" id="s2_${i}" class="score-input" value="${m.s2??''}" ${m.done || !isAdmin()?'disabled':''}></div>
                    ${!m.done && isAdmin() ? `<button class="btn-primary" onclick="validateMatch(${i})">VALIDER</button>` : ''}
                </div>`).join('')}</div>`;
        }
    }

    if (tab === "players") {
        app.innerHTML = `<h3>Gestion</h3>
        ${isAdmin() ? `<div class="card"><input id="pName" placeholder="Nouveau..." style="width:70%; padding:8px; background:#000; border:1px solid #333; color:#fff"> <button onclick="addPlayer()" style="padding:8px">+</button></div>` : ''}
        ${state.players.map(p => `
            <div class="card" style="display:flex; justify-content:space-between">
                <div><strong>${p.name}</strong><br><small>Points: ${p.points}</small></div>
                ${isAdmin() ? `<div>
                    <button onclick="rewardPlayer('${p.id}')" style="color:var(--accent); background:none; border:none; font-size:1.2rem; cursor:pointer"><i class="fas fa-plus-circle"></i></button>
                    <button onclick="penalizePlayer('${p.id}')" style="color:var(--danger); background:none; border:none; font-size:1.2rem; cursor:pointer; margin-left:10px"><i class="fas fa-minus-circle"></i></button>
                </div>` : ''}
            </div>`).join('')}`;
    }

    if (tab === "hof") {
        app.innerHTML = `<h3>Hall of Fame</h3>`;
        // Logique simplifiÃ©e du HOF
        state.players.forEach(p => {
            app.innerHTML += `<div class="medal-card medal-gold"><strong>${p.name}</strong><span style="margin-left:auto">Valeur: ${calculateValue(p)}M</span></div>`;
        });
    }
}

// --- ACTIONS ADMIN ---
function rewardPlayer(id) { 
    if(!isAdmin()) return;
    const p = state.players.find(x => x.id === id); 
    const pts = prompt(`Points Ã  ajouter Ã  ${p.name} ?`, "1");
    if(pts) { p.points = (parseInt(p.points)||0) + parseInt(pts); save(); }
}

function penalizePlayer(id) { 
    if(!isAdmin()) return;
    const p = state.players.find(x => x.id === id); 
    const pts = prompt(`Points Ã  retirer Ã  ${p.name} ?`, "1");
    if(pts) { p.points = (parseInt(p.points)||0) - parseInt(pts); save(); }
}

function addPlayer() { 
    const n = qs("#pName").value; 
    if(n) { state.players.push({id:Date.now().toString(), name:n, points:0, gf:0, ga:0, cs:0}); save(); } 
}

function startDay() {
    state.currentDay = [];
    for(let i=0; i<state.players.length; i++) {
        for(let j=i+1; j<state.players.length; j++) {
            state.currentDay.push({p1:state.players[i].name, p2:state.players[j].name, s1:null, s2:null, done:false, seasonRef:state.season});
        }
    }
    save();
}

function validateMatch(i) {
    const s1 = parseInt(qs(`#s1_${i}`).value);
    const s2 = parseInt(qs(`#s2_${i}`).value);
    if(isNaN(s1) || isNaN(s2)) return;
    
    const m = state.currentDay[i];
    const p1 = state.players.find(p => p.name === m.p1);
    const p2 = state.players.find(p => p.name === m.p2);
    
    p1.gf += s1; p1.ga += s2; p2.gf += s2; p2.ga += s1;
    if(s1 > s2) p1.points += 3; else if(s2 > s1) p2.points += 3; else { p1.points += 1; p2.points += 1; }
    if(s2 === 0) p1.cs = (p1.cs||0)+1; if(s1 === 0) p2.cs = (p2.cs||0)+1;
    
    m.s1 = s1; m.s2 = s2; m.done = true;
    if(state.currentDay.every(x => x.done)) {
        if(!state.archives) state.archives = [];
        state.archives.push([...state.currentDay]);
        state.currentDay = [];
    }
    save();
}

function finishSeason() {
    const sorted = [...state.players].sort((a,b) => b.points - a.points);
    qs("#winnerName").innerText = sorted[0].name;
    qs("#winnerModal").style.display = "flex";
}

function closeWinner() {
    state.season++;
    state.players.forEach(p => { p.points = 0; p.gf = 0; p.ga = 0; p.cs = 0; });
    state.currentDay = [];
    qs("#winnerModal").style.display = "none";
    save();
}

document.querySelectorAll("nav button").forEach(btn => {
    btn.onclick = () => {
        document.querySelectorAll("nav button").forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        render();
    };
});

pullData();
</script>
</body>
</html>
