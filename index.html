<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>FC26 Manager - Ultimate Data Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
:root {
--bg: #05070a; --card: #111418; --border: #30363d;
--accent: #238636; --blue: #58a6ff; --gold: #d4af37;
--text: #f8fafc; --muted: #8b949e; --danger: #da3633;
--purple: #8957e5; --silver: #c0c0c0; --bronze: #cd7f32;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 90px; }

#syncNotify { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: var(--purple); color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; z-index: 2000; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); transition: 0.3s; }

#loginOverlay, #pinOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
#pinOverlay { display: none; background: rgba(5, 7, 10, 0.98); }
.login-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; margin-top: 30px; }
.user-btn { background: var(--card); border: 1px solid var(--border); color: white; padding: 20px; border-radius: 15px; cursor: pointer; text-align: center; transition: 0.3s; }
.user-btn:hover { border-color: var(--purple); transform: translateY(-5px); }
.admin-lock { border-color: var(--gold); }
.pin-input { background: #000; border: 2px solid var(--border); color: var(--gold); font-size: 2rem; width: 150px; text-align: center; border-radius: 12px; margin: 20px 0; letter-spacing: 10px; padding: 10px; }

header { background: #010409; padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; z-index:100; }
.season-badge { background: var(--gold); color: #000; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
.sync-status { font-size: 0.6rem; color: var(--accent); display: flex; align-items: center; gap: 5px; }

nav { position: fixed; bottom: 0; left: 0; right: 0; background: #111418; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid var(--border); z-index: 1000; }
nav button { background: none; border: none; color: var(--muted); display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; gap: 5px; cursor: pointer; }
nav button.active { color: var(--accent); }

main { padding: 15px; max-width: 600px; margin: auto; }
.card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 16px; position: relative; }

/* Hall of Fame Styles */
.hof-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
.hof-card { background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 12px; text-align: center; border-bottom: 3px solid var(--gold); }
.hof-label { font-size: 0.55rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
.hof-value { font-size: 0.85rem; font-weight: bold; color: var(--text); display: block; margin-top: 4px; }
.hof-sub { font-size: 0.6rem; color: var(--gold); }

.awards-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 15px; scrollbar-width: none; }
.award-card { min-width: 130px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; text-align: center; }
.award-winner { font-size: 0.8rem; font-weight: bold; color: var(--gold); display: block; margin-top: 5px; }

table { width: 100%; border-collapse: collapse; }
th { color: var(--muted); font-size: 0.6rem; text-transform: uppercase; padding-bottom: 10px; }
td { padding: 12px 2px; border-bottom: 1px solid #30363d55; font-size: 0.85rem; vertical-align: middle; }
.col-player { text-align: left; padding-left: 5px; width: 35%; }
.col-center { text-align: center; }

.val-badge { background: #1e1b4b; color: var(--blue); padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.7rem; }

.form-container { display: flex; gap: 4px; justify-content: center; }
.dot { width: 9px; height: 9px; border-radius: 50%; }
.win { background: var(--accent); box-shadow: 0 0 5px var(--accent); }
.loss { background: var(--danger); }
.draw { background: var(--muted); }

.predict-card { background: linear-gradient(135deg, #1e1b4b 0%, #111418 100%); border: 1px solid var(--purple); padding: 20px; }
.brief-box { background: #0a0c10; border-left: 4px solid var(--gold); padding: 12px; margin-top: 10px; font-size: 0.75rem; border-radius: 4px; }

.match-card { border-bottom: 1px solid var(--border); padding: 15px 0; }
.team-row { display: flex; align-items: center; justify-content: space-between; margin: 8px 0; }
.team-select { background: #000; color: white; border: 1px solid var(--border); border-radius: 8px; padding: 6px; font-size: 0.7rem; width: 110px; }
.score-input { width: 45px; height: 40px; background: #000; border: 1px solid var(--border); color: white; text-align: center; border-radius: 8px; font-weight: bold; font-size: 1.1rem; }

.btn-primary { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; }
.btn-edit { background: none; border: 1px solid var(--blue); color: var(--blue); padding: 4px 8px; border-radius: 6px; font-size: 0.6rem; }

#winnerModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:2000; justify-content:center; align-items:center; text-align:center; padding: 20px; }
</style>
</head>
<body>

<div id="syncNotify"><i class="fas fa-sync-alt fa-spin"></i> Mise √† jour Live...</div>

<div id="loginOverlay">
<i class="fas fa-shield-halved" style="font-size: 3rem; color: var(--purple); margin-bottom: 10px;"></i>
<h2 style="margin:0">FC26 ELITE</h2>
<div class="login-grid">
<div class="user-btn admin-lock" onclick="checkPin()"><i class="fas fa-user-crown" style="color:var(--gold)"></i>ADMIN</div>
<div class="user-btn" onclick="login('BVI')"><i class="fas fa-user"></i>BVI</div>
<div class="user-btn" onclick="login('NAD')"><i class="fas fa-user"></i>NAD</div>
<div class="user-btn" onclick="login('WIL')"><i class="fas fa-user"></i>WIL</div>
<div class="user-btn" onclick="login('BROOK')"><i class="fas fa-user"></i>BROOK</div>
</div>
</div>

<div id="pinOverlay">
<input type="password" id="pinCode" class="pin-input" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
<button class="btn-primary" onclick="validatePin()">OK</button>
</div>

<div id="winnerModal">
<div style="background: var(--card); padding: 40px; border-radius: 30px; border: 2px solid var(--gold);">
<i class="fas fa-trophy" style="font-size: 4rem; color: var(--gold); margin-bottom: 20px;"></i>
<h1 id="winnerName">-</h1>
<button class="btn-primary" onclick="closeWinner()">NOUVELLE SAISON üî•</button>
</div>
</div>

<header>
<div onclick="logout()" style="cursor:pointer"><i class="fas fa-power-off"></i> <span id="userDisplay" style="font-size:0.7rem; color:var(--muted); margin-left:5px"></span></div>
<div style="display:flex; align-items:center; gap:10px">
<div class="sync-status" id="syncStatus"><i class="fas fa-circle" style="font-size:0.5rem"></i> LIVE</div>
<div id="seasonBadge" class="season-badge">Saison 1</div>
</div>
</header>

<main id="app"></main>

<nav>
<button class="active" data-tab="dashboard"><i class="fas fa-chart-line"></i><span>Stats</span></button>
<button data-tab="analysis"><i class="fas fa-brain"></i><span>IA</span></button>
<button data-tab="matches"><i class="fas fa-gamepad"></i><span>Jouer</span></button>
<button data-tab="players"><i class="fas fa-users"></i><span>Joueurs</span></button>
<button data-tab="archives"><i class="fas fa-history"></i><span>Palmar√®s</span></button>
</nav>

<script>
const FB_URL = "https://fc26-e596e-default-rtdb.europe-west1.firebasedatabase.app/data.json";
const ADMIN_PIN = "1234";
const TEAMS = ["Real Madrid", "Man City", "Barcelone", "Bayern Munich", "Liverpool", "PSG", "Arsenal", "Inter Milan", "Milan AC", "Atletico", "Leverkusen", "Dortmund", "Juventus", "Naples", "Chelsea", "Aston Villa"];

let currentUser = localStorage.getItem("fc26_user") || null;
let state = { season: 1, players: [], currentDay: [], archives: [], rotationQueue: [] };
let isInteracting = false;

const notifySound = new Audio("https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3");
const qs = (s) => document.querySelector(s);
const isAdmin = () => currentUser === 'ADMIN';

async function pushData() { if (isAdmin()) { try { await fetch(FB_URL, { method: 'PUT', body: JSON.stringify(state) }); } catch (e) {} } }
async function pullData() {
if (isInteracting) return;
try {
const res = await fetch(FB_URL);
const data = await res.json();
if (data && JSON.stringify(data) !== JSON.stringify(state)) {
state = data; render(); showNotify(); qs('#seasonBadge').innerText = `SAISON ${state.season}`;
}
} catch (e) {}
}

function showNotify() { const n = qs("#syncNotify"); n.style.display = "block"; notifySound.play().catch(e => {}); setTimeout(() => { n.style.display = "none"; }, 3000); }
setInterval(pullData, 5000);

function checkPin() { qs('#pinOverlay').style.display = 'flex'; qs('#pinCode').focus(); }
function validatePin() { if(qs('#pinCode').value === ADMIN_PIN) { qs('#pinOverlay').style.display = 'none'; login('ADMIN'); } else { alert("PIN Incorrect"); } }
function login(user) { currentUser = user; localStorage.setItem("fc26_user", user); qs('#loginOverlay').style.display = 'none'; qs('#userDisplay').innerText = user; pullData(); }
function logout() { localStorage.removeItem("fc26_user"); location.reload(); }
if(currentUser) login(currentUser);
function save() { if(isAdmin()) pushData(); render(); }

// --- LOGIQUE STATISTIQUES SAISONS ---
function calculateValue(p) { return (10 + (p.points * 1.5) + ((p.gf - p.ga) * 0.5)).toFixed(1); }

function getSeasonStats(sNum) {
    if(!state.archives) return null;
    let pts = {}; let goals = {}; let ga = {}; let games = {};
    state.archives.flat().filter(m => m.seasonRef == sNum).forEach(m => {
        [m.p1, m.p2].forEach(p => { 
            if(!pts[p]) { pts[p]=0; goals[p]=0; ga[p]=0; games[p]=0; } 
            games[p]++;
        });
        goals[m.p1] += m.s1; goals[m.p2] += m.s2;
        ga[m.p1] += m.s2; ga[m.p2] += m.s1;
        if(m.s1 > m.s2) pts[m.p1] += 3; else if(m.s2 > m.s1) pts[m.p2] += 3; else { pts[m.p1]+=1; pts[m.p2]+=1; }
    });
    if(Object.keys(pts).length === 0) return null;
    let sorted = Object.keys(pts).sort((a,b) => pts[b] - pts[a] || (goals[b]-ga[b]) - (goals[a]-ga[a]));
    let pichichi = Object.keys(goals).sort((a,b) => goals[b] - goals[a])[0];
    let bestDef = Object.keys(ga).sort((a,b) => ga[a] - ga[b])[0];
    return { winner: sorted[0], runnerUp: sorted[1], pichichi, pichichiGoals: goals[pichichi], bestDef };
}

function getAllTimeRecords() {
    if(!state.archives || state.archives.length === 0) return { goat: "-", topScorer: "-", wall: "-", seasonsCount: 0 };
    let titles = {}; let totalGoals = {}; let totalGa = {}; let totalGames = {};
    
    // On boucle sur chaque saison termin√©e
    for(let i=1; i < state.season; i++) {
        let s = getSeasonStats(i);
        if(s) titles[s.winner] = (titles[s.winner] || 0) + 1;
    }
    
    // Stats cumul√©es
    state.archives.flat().forEach(m => {
        [m.p1, m.p2].forEach(p => { if(!totalGoals[p]) { totalGoals[p]=0; totalGa[p]=0; totalGames[p]=0; } totalGames[p]++; });
        totalGoals[m.p1] += m.s1; totalGoals[m.p2] += m.s2;
        totalGa[m.p1] += m.s2; totalGa[m.p2] += m.s1;
    });

    let goat = Object.keys(titles).sort((a,b) => titles[b] - titles[a])[0] || "-";
    let topScorer = Object.keys(totalGoals).sort((a,b) => totalGoals[b] - totalGoals[a])[0] || "-";
    let wall = Object.keys(totalGa).sort((a,b) => (totalGa[a]/totalGames[a]) - (totalGa[b]/totalGames[b]))[0] || "-";

    return { 
        goat, titles: titles[goat] || 0, 
        topScorer, goals: totalGoals[topScorer] || 0,
        wall, seasonsCount: state.season - 1
    };
}

function getForm(name) {
const history = []; const allMatches = state.archives ? state.archives.flat() : [];
[...allMatches].reverse().forEach(m => {
if((m.p1 === name || m.p2 === name) && history.length < 5) {
const win = (m.p1 === name) ? m.s1 > m.s2 : m.s2 > m.s1;
const draw = m.s1 === m.s2;
history.push(win ? 'win' : (draw ? 'draw' : 'loss'));
}
});
return history;
}

// --- RENDU ---
function render() {
const tab = qs("nav button.active").dataset.tab;
const app = qs("#app"); app.innerHTML = "";

if (tab === "dashboard") {
    const sorted = [...state.players].sort((a,b) => b.points - a.points || (b.gf-b.ga)-(a.gf-a.ga));
    const pichichi = [...state.players].sort((a,b) => b.gf - a.gf)[0];
    const defense = [...state.players].sort((a,b) => a.ga - b.ga)[0];
    const topVal = sorted.length ? [...state.players].sort((a,b) => calculateValue(b) - calculateValue(a))[0] : null;

    app.innerHTML = `<div id="pdf-area">
    <div class="awards-scroll">
    <div class="award-card">‚öΩ <div class="award-winner">${pichichi?.name || '-'}</div><div style="font-size:0.5rem">PICHICHI</div></div>
    <div class="award-card">üõ°Ô∏è <div class="award-winner">${defense?.name || '-'}</div><div style="font-size:0.5rem">LE ROC</div></div>
    <div class="award-card">üíé <div class="award-winner">${topVal ? calculateValue(topVal) : '0'}M</div><div style="font-size:0.5rem">VALEUR TOP</div></div>
    </div>
    <h3>Classement S${state.season}</h3>
    <div class="card">
    <table>
    <thead><tr><th class="col-player">Joueur</th><th class="col-center">Pts</th><th class="col-center">GD</th><th class="col-center">Valeur</th><th class="col-center">Forme</th></tr></thead>
    <tbody>${sorted.map(p => `<tr><td class="col-player"><strong>${p.name}</strong></td><td class="col-center" style="color:var(--blue); font-weight:bold">${p.points}</td><td class="col-center">${p.gf-p.ga}</td><td class="col-center"><span class="val-badge">${calculateValue(p)}M</span></td><td class="col-center"><div class="form-container">${getForm(p.name).map(f => `<div class="dot ${f}"></div>`).join('')}</div></td></tr>`).join('')}</tbody>
    </table>
    </div>
    </div>${isAdmin() ? `<button class="btn-primary" style="background:var(--danger); margin-top:10px" onclick="finishSeason()">TERMINER LA SAISON</button>` : ''}`;
}

if (tab === "archives") {
    const records = getAllTimeRecords();
    app.innerHTML = `<h3>üèÜ Temple de la Renomm√©e</h3>
    <div class="hof-grid">
        <div class="hof-card">
            <span class="hof-label"><i class="fas fa-crown"></i> Le GOAT</span>
            <span class="hof-value">${records.goat}</span>
            <span class="hof-sub">${records.titles} Titres</span>
        </div>
        <div class="hof-card">
            <span class="hof-label"><i class="fas fa-fire"></i> Soulier d'Or</span>
            <span class="hof-value">${records.topScorer}</span>
            <span class="hof-sub">${records.goals} Buts Total</span>
        </div>
        <div class="hof-card">
            <span class="hof-label"><i class="fas fa-shield-alt"></i> Le Mur</span>
            <span class="hof-value">${records.wall}</span>
            <span class="hof-sub">Meilleure D√©fense</span>
        </div>
        <div class="hof-card">
            <span class="hof-label"><i class="fas fa-history"></i> Saisons</span>
            <span class="hof-value">${records.seasonsCount}</span>
            <span class="hof-sub">Disput√©es</span>
        </div>
    </div>

    <h3>üìú Historique des Champions</h3>
    <div class="card">
        <table>
            <thead><tr><th>Sais.</th><th>Vainqueur</th><th>Dauphin</th><th>Buteur</th></tr></thead>
            <tbody>
                ${Array.from({length: state.season-1}, (_, i) => i+1).reverse().map(sNum => {
                    let s = getSeasonStats(sNum);
                    if(!s) return "";
                    return `<tr>
                        <td class="col-center" style="color:var(--gold); font-weight:bold">${sNum}</td>
                        <td class="col-center"><b>${s.winner}</b></td>
                        <td class="col-center" style="color:var(--muted)">${s.runnerUp || "-"}</td>
                        <td class="col-center" style="font-size:0.7rem">${s.pichichi} (${s.pichichiGoals})</td>
                    </tr>`;
                }).join('')}
            </tbody>
        </table>
    </div>

    <h3>üìÖ D√©tail des Journ√©es</h3>
    ${(state.archives || []).slice().reverse().map((day, dIdx) => `
        <details class="card" style="padding:10px; margin-bottom:10px">
            <summary style="font-size:0.8rem; font-weight:bold; color:var(--blue)">Saison ${day[0].seasonRef} - ${day[0].date}</summary>
            <div style="margin-top:10px">
                ${day.map((m, mIdx) => `
                    <div style="display:flex; justify-content:space-between; font-size:0.75rem; padding:5px 0; border-bottom:1px solid #333">
                        <span>${m.p1} vs ${m.p2}</span>
                        <b style="color:var(--gold)">${m.s1} - ${m.s2}</b>
                    </div>
                `).join('')}
            </div>
        </details>
    `).join('')}`;
}

// Les autres onglets restent inchang√©s (IA, Jouer, Joueurs)
if (tab === "analysis") {
    app.innerHTML = `<h3>üß† Analyse IA</h3><div class="card brief-box">Analyse en cours... S√©lectionnez un match ou un joueur pour un briefing.</div>`;
    // ... Garder ta logique IA ici ...
}

if (tab === "matches") {
    if (!state.currentDay || state.currentDay.length === 0) {
        app.innerHTML = `<div class="card" style="text-align:center; padding:40px">${isAdmin() ? `<button class="btn-primary" onclick="startDay()">LANCER LA JOURN√âE ‚öΩ</button>` : `<p>Attente de l'Admin...</p>`}</div>`;
    } else {
        app.innerHTML = `<h3>Matchs S${state.season}</h3><div class="card">${state.currentDay.map((m, i) => `<div class="match-card"><div class="team-row"><span>${m.p1}</span><input type="number" id="s1_${i}" class="score-input" onfocus="isInteracting=true"></div><div class="team-row"><span>${m.p2}</span><input type="number" id="s2_${i}" class="score-input" onfocus="isInteracting=true"></div>${isAdmin() ? `<button class="btn-primary" onclick="validateMatch(${i})">VALIDER ‚úÖ</button>` : ''}</div>`).join('')}</div>`;
    }
}

if (tab === "players") {
    app.innerHTML = `<h3>Effectif üë•</h3>${isAdmin() ? `<div class="card"><input id="pName" placeholder="Nouveau joueur..." style="width:70%; background:#000; color:white; border:1px solid #333; padding:10px; border-radius:10px"><button onclick="addPlayer()" class="btn-primary" style="width:25%; margin-left:5%">+</button></div>` : ''}${state.players.map(p => `<div class="card"><strong>${p.name}</strong></div>`).join('')}`;
}
}

// --- CORE ACTIONS (Inchang√©es pour pr√©server la stabilit√©) ---
function startDay(){ if(isAdmin()){ state.currentDay=[]; for(let i=0; i<state.players.length; i++) for(let j=i+1; j<state.players.length; j++) state.currentDay.push({p1:state.players[i].name, p2:state.players[j].name, s1:null, s2:null, done:false, seasonRef:state.season, date:new Date().toLocaleDateString('fr-FR')}); save(); } }
function validateMatch(i){ if(isAdmin()){ const s1=parseInt(qs(`#s1_${i}`).value), s2=parseInt(qs(`#s2_${i}`).value); if(isNaN(s1)||isNaN(s2)) return; const m=state.currentDay[i]; const p1=state.players.find(p=>p.name===m.p1), p2=state.players.find(p=>p.name===m.p2); p1.gf+=s1; p1.ga+=s2; p2.gf+=s2; p2.ga+=s1; if(s1>s2) p1.points+=3; else if(s2>s1) p2.points+=3; else {p1.points+=1; p2.points+=1;} m.s1=s1; m.s2=s2; m.done=true; if(state.currentDay.every(x=>x.done)){ if(!state.archives) state.archives=[]; state.archives.push([...state.currentDay]); state.currentDay=[]; } isInteracting=false; save(); } }
function finishSeason(){ if(isAdmin()){ const s=[...state.players].sort((a,b)=>b.points-a.points); if(s.length){qs("#winnerName").innerText=s[0].name; qs("#winnerModal").style.display="flex";} } }
function closeWinner(){ state.season++; state.players.forEach(p=>{p.points=0; p.gf=0; p.ga=0;}); state.currentDay=[]; qs("#winnerModal").style.display="none"; save(); }
function addPlayer(){ if(isAdmin()){ const n=qs("#pName").value.trim(); if(n){state.players.push({id:crypto.randomUUID(), name:n, points:0, gf:0, ga:0}); save();}} }

document.querySelectorAll("nav button").forEach(btn => { btn.onclick = () => { isInteracting = false; document.querySelectorAll("nav button").forEach(b=>b.classList.remove('active')); btn.classList.add('active'); render(); }; });
pullData();
</script>
</body>
</html>
